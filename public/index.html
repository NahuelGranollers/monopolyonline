<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Monopoly Poblenou Barcelona</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg: #c8d4c0;
    --panel: #fefdf5;
    --accent: #ed1b24;
    --text: #000000;
    --tile-bg: #fefdf5;
    --tile-border: #000000;
    --board-border: #8b7355;
    
    --brown: #8b4513;
    --lightblue: #aaddf6;
    --pink: #d93a96;
    --orange: #f7941d;
    --red: #ed1b24;
    --yellow: #fef200;
    --green: #1fb25a;
    --darkblue: #0072bb;
    --rail: #2d2d2d;
    --utility: #87ceeb;
    
    --tile-size: 78px;
    --success: #1fb25a;
    --error: #ed1b24;
    --warning: #f7941d;
  }

  body.dark-mode {
    --bg: #0a0e27;
    --panel: #1a1f3a;
    --accent: #00d4ff;
    --text: #e6f1ff;
    --tile-bg: #15182b;
    --tile-border: #2a3050;
    --board-border: #2a3050;
    --success: #00ff88;
    --error: #ff4757;
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Arial', 'Helvetica', sans-serif;
    background: var(--bg);
    color: var(--text);
    transition: all 0.3s;
  }

  #app {
    display: flex;
    height: 100vh;
    gap: 12px;
    padding: 12px;
    box-sizing: border-box;
    position: relative;
  }

  /* Logo MONOPB9 diagonal en el centro */
  #app::before {
    content: 'MONOPB9';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 80px;
    font-weight: 900;
    color: var(--accent);
    opacity: 0.1;
    pointer-events: none;
    z-index: 1;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    font-family: 'Arial Black', sans-serif;
    letter-spacing: -2px;
  }

  /* Bot√≥n de toggle oscuro */
  #themeToggle {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 10000;
    padding: 10px 16px;
    border-radius: 4px;
    border: 2px solid var(--tile-border);
    background: var(--accent);
    color: #fff;
    font-weight: 900;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    text-transform: uppercase;
  }

  #themeToggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  body.dark-mode #themeToggle {
    background: #00d4ff;
    color: #000;
  }

  .left {
    width: 420px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 10;
    position: relative;
  }

  .boardWrap {
    flex: 1;
    background: linear-gradient(135deg, #c8d4c0 0%, #b8c4b0 100%);
    border: 8px solid var(--board-border);
    border-radius: 4px;
    padding: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3), inset 0 0 40px rgba(0,0,0,0.1);
    z-index: 10;
    transition: all 0.3s;
  }

  body.dark-mode .boardWrap {
    background: linear-gradient(135deg, #0f1424 0%, #1a1f3a 100%);
    box-shadow: inset 0 0 50px rgba(0, 212, 255, 0.1);
  }

  .sidebar {
    background: var(--panel);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 3px solid var(--board-border);
    border-radius: 4px;
    padding: 12px;
    overflow: auto;
    transition: all 0.3s;
  }

  body.dark-mode .sidebar {
    box-shadow: 0 8px 24px rgba(0,0,0,.5), 0 0 20px rgba(0,212,255,0.1);
    border-color: rgba(0,212,255,0.2);
  }

  h2 {
    margin: 6px 0 10px 0;
    font-size: 16px;
    font-weight: 900;
    color: var(--accent);
    text-transform: uppercase;
    border-bottom: 2px solid var(--accent);
    padding-bottom: 6px;
    transition: all 0.3s;
  }

  body.dark-mode h2 {
    text-shadow: 0 0 10px rgba(0,212,255,0.5);
  }

  .controls {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  .controls input {
    flex: 1;
    padding: 9px;
    border: 2px solid var(--tile-border);
    border-radius: 4px;
    font-size: 14px;
    background: var(--tile-bg);
    color: var(--text);
    font-weight: 600;
    transition: all 0.3s;
  }

  .controls input:focus {
    outline: none;
    border: 2px solid var(--accent);
    box-shadow: 0 0 8px rgba(237, 27, 36, 0.3);
  }

  body.dark-mode .controls input:focus {
    box-shadow: 0 0 10px rgba(0,212,255,0.3);
  }

  .controls input::placeholder {
    color: #999;
  }

  .controls button {
    padding: 9px 16px;
    border-radius: 4px;
    border: 2px solid var(--tile-border);
    background: var(--accent);
    color: #fff;
    cursor: pointer;
    font-weight: 900;
    transition: all 0.3s;
    text-transform: uppercase;
    font-size: 12px;
  }

  body.dark-mode .controls button {
    background: #00d4ff;
    color: #000;
    box-shadow: 0 0 15px rgba(0,212,255,0.3);
  }

  .controls button:hover {
    background: #d41321;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  body.dark-mode .controls button:hover {
    background: #00ffea;
    box-shadow: 0 0 25px rgba(0,212,255,0.6);
  }

  .controls button:disabled {
    background: #ccc;
    color: #666;
    cursor: not-allowed;
    transform: none;
  }

  body.dark-mode .controls button:disabled {
    background: #2a3050;
    color: #555;
  }

  .playersList {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .playerCard {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-radius: 4px;
    border: 2px solid var(--tile-border);
    background: var(--tile-bg);
    transition: all 0.2s;
  }

  body.dark-mode .playerCard {
    border-color: var(--tile-border);
    background: var(--tile-bg);
  }

  .playerCard:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  body.dark-mode .playerCard:hover {
    border-color: var(--accent);
    box-shadow: 0 0 15px rgba(0,212,255,0.2);
  }

  .playerCard.active {
    border: 2px solid var(--accent);
    background: rgba(237, 27, 36, 0.05);
  }

  body.dark-mode .playerCard.active {
    box-shadow: 0 0 0 2px var(--accent);
    background: rgba(0,212,255,0.1);
  }

  .playerCard.disconnected {
    opacity: 0.5;
    border-color: var(--error);
  }

  .token {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    background: #666;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  body.dark-mode .token {
    box-shadow: 0 0 10px rgba(0,212,255,0.3);
  }

  .btnRow {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }

  button.action {
    padding: 10px 14px;
    background: var(--accent);
    color: #fff;
    border: 2px solid var(--tile-border);
    border-radius: 4px;
    cursor: pointer;
    font-weight: 900;
    transition: all 0.3s;
    font-size: 12px;
    text-transform: uppercase;
  }

  body.dark-mode button.action {
    background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
    color: #000;
    box-shadow: 0 4px 15px rgba(0,212,255,0.3);
  }

  button.action:hover:not(:disabled) {
    background: #d41321;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  body.dark-mode button.action:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,212,255,0.5);
  }

  button.action:disabled {
    background: #ccc;
    color: #666;
    cursor: not-allowed;
    transform: none;
  }

  body.dark-mode button.action:disabled {
    background: #2a3050;
    color: #555;
  }

  .log {
    background: var(--tile-bg);
    border: 2px solid var(--tile-border);
    padding: 8px;
    height: 140px;
    overflow: auto;
    border-radius: 4px;
    font-size: 13px;
    line-height: 1.5;
    font-family: 'Courier New', monospace;
    transition: all 0.3s;
  }

  .log div {
    padding: 2px 0;
    border-bottom: 1px solid #eee;
    color: #333;
  }

  body.dark-mode .log div {
    border-bottom-color: var(--tile-border);
    color: var(--text);
  }

  .log div:last-child {
    border: none;
  }

  .board {
    width: calc(var(--tile-size) * 11 + 20px);
    height: calc(var(--tile-size) * 11 + 20px);
    position: relative;
    border-radius: 0;
    perspective: 800px;
    background: var(--bg);
    transition: all 0.3s;
  }

  .boardInner {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .tile {
    width: var(--tile-size);
    height: var(--tile-size);
    background: var(--tile-bg);
    border: 2px solid var(--tile-border);
    border-radius: 0;
    position: absolute;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 6px;
    box-sizing: border-box;
    font-size: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: all 0.3s;
  }

  body.dark-mode .tile {
    box-shadow: 0 4px 12px rgba(0,0,0,.5), 0 0 10px rgba(0,212,255,0.1);
  }

  .tile:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  }

  body.dark-mode .tile:hover {
    border-color: var(--accent);
    box-shadow: 0 6px 20px rgba(0,0,0,.7), 0 0 20px rgba(0,212,255,0.3);
  }

  .tile .title {
    font-size: 11px;
    font-weight: 900;
    line-height: 1.2;
    color: var(--text);
    text-transform: uppercase;
    text-align: center;
  }

  body.dark-mode .tile .title {
    text-shadow: 0 0 5px rgba(0,212,255,0.3);
  }

  .colorBar {
    height: 14px;
    border-radius: 0;
    margin-top: 2px;
    border-bottom: 1px solid rgba(0,0,0,0.2);
    box-shadow: 0 0 10px currentColor;
  }

  .playersMarkers {
    display: flex;
    gap: 4px;
    margin-top: 6px;
    flex-wrap: wrap;
  }

  .tokenSmall {
    width: 14px;
    height: 14px;
    border-radius: 2px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    animation: pulse 0.5s ease-in-out;
  }

  body.dark-mode .tokenSmall {
    box-shadow: 0 2px 6px rgba(0,0,0,.5), 0 0 8px currentColor;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  .ownerBadge {
    position: absolute;
    right: 2px;
    bottom: 2px;
    width: 12px;
    height: 12px;
    border-radius: 2px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }

  body.dark-mode .ownerBadge {
    box-shadow: 0 0 8px currentColor;
  }

  .modal-simple {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.7);
    z-index: 99999;
    animation: fadeIn 0.3s;
  }

  body.dark-mode .modal-simple {
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(10px);
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .diceBox {
    display: flex;
    gap: 28px;
    align-items: center;
    justify-content: center;
    flex-direction: row;
  }

  .dieSimple {
    width: 180px;
    height: 180px;
    border-radius: 8px;
    background: var(--tile-bg);
    border: 3px solid var(--tile-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 96px;
    font-weight: 900;
    color: var(--text);
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    transition: all 0.3s;
  }

  body.dark-mode .dieSimple {
    background: linear-gradient(135deg, #1a1f3a 0%, #0f1424 100%);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 18px 48px rgba(0,0,0,.8), 0 0 30px rgba(0,212,255,0.5);
    text-shadow: 0 0 20px rgba(0,212,255,0.8);
  }

  .diePulse {
    animation: dicePulse 0.3s ease-in-out;
  }

  @keyframes dicePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1) rotate(5deg); }
  }

  .caption {
    color: var(--text);
    margin-top: 20px;
    font-weight: 900;
    font-size: 20px;
    text-transform: uppercase;
    transition: all 0.3s;
  }

  body.dark-mode .caption {
    color: var(--accent);
    text-shadow: 0 0 15px rgba(0,212,255,0.8);
  }

  .alert {
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px;
    font-size: 13px;
    font-weight: 600;
    animation: slideIn 0.3s;
    border: 2px solid;
    transition: all 0.3s;
  }

  @keyframes slideIn {
    from { transform: translateY(-10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .alert.success {
    background: #d4edda;
    color: #155724;
    border-color: #1fb25a;
  }

  body.dark-mode .alert.success {
    background: rgba(0,255,136,0.1);
    color: var(--success);
    border-color: var(--success);
    box-shadow: 0 0 15px rgba(0,255,136,0.2);
  }

  .alert.error {
    background: #f8d7da;
    color: #721c24;
    border-color: var(--error);
  }

  body.dark-mode .alert.error {
    background: rgba(255,71,87,0.1);
    color: var(--error);
    border-color: var(--error);
    box-shadow: 0 0 15px rgba(255,71,87,0.2);
  }

  .alert.info {
    background: #d1ecf1;
    color: #0c5460;
    border-color: var(--lightblue);
  }

  body.dark-mode .alert.info {
    background: rgba(0,212,255,0.1);
    color: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 0 15px rgba(0,212,255,0.2);
  }

  .status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
  }

  body.dark-mode .status-indicator {
    box-shadow: 0 0 8px currentColor;
  }

  .status-indicator.online {
    background: var(--success);
  }

  .status-indicator.offline {
    background: var(--error);
  }

  .roomId {
    background: #f0e5d8;
    padding: 4px 8px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    display: inline-block;
    margin-top: 6px;
    border: 2px solid var(--tile-border);
    color: var(--accent);
    font-weight: 900;
    transition: all 0.3s;
  }

  body.dark-mode .roomId {
    background: var(--tile-bg);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 10px rgba(0,212,255,0.2);
  }

  #status {
    color: var(--text);
    font-size: 13px;
    padding: 8px;
    background: #f0e5d8;
    border-radius: 4px;
    border: 2px solid var(--tile-border);
    transition: all 0.3s;
  }

  body.dark-mode #status {
    background: var(--tile-bg);
    border-color: var(--tile-border);
  }

  #copyRoomBtn {
    margin-left: 8px;
    padding: 4px 8px;
    font-size: 11px;
    background: var(--success);
    color: #fff;
    border: 2px solid var(--tile-border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
  }

  body.dark-mode #copyRoomBtn {
    background: var(--success);
    color: #000;
    box-shadow: 0 0 10px rgba(0,255,136,0.3);
  }

  #copyRoomBtn:hover {
    background: #1f9d4a;
  }

  @media (max-width: 900px) {
    #app {
      flex-direction: column;
      height: auto;
    }
    .left {
      width: 100%;
      order: 2;
    }
    .boardWrap {
      width: 100%;
      height: 450px;
      order: 1;
    }
    .board {
      transform: scale(0.65);
    }
    .dieSimple {
      width: 120px;
      height: 120px;
      font-size: 64px;
    }
    .diceBox {
      gap: 16px;
    }
    #themeToggle {
      top: 60px;
    }
  }

  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--bg);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #d41321;
  }

  body.dark-mode ::-webkit-scrollbar-thumb {
    background: var(--accent);
  }

  body.dark-mode ::-webkit-scrollbar-thumb:hover {
    background: #00ffea;
  }
</style>
</head>
<body>

<!-- Bot√≥n para cambiar tema -->
<button id="themeToggle">üåô Oscuro</button>

<div id="app">
  <div class="left">
    <div class="sidebar">
      <h2>üé≤ Monopoly Poblenou</h2>
      <div id="alerts"></div>

      <div class="controls">
        <input id="name" placeholder="Tu nombre" maxlength="20">
        <button id="joinBtn">Unirse</button>
      </div>
      <div class="controls">
        <input id="room" placeholder="ID de sala" maxlength="20">
        <button id="createBtn">Crear Sala</button>
        <button id="startBtn" disabled>Comenzar</button>
      </div>

      <div>
        <p id="status"></p>
      </div>

      <div id="roomInfo" style="display:none">
        <span class="status-indicator online"></span>
        <strong>Sala:</strong> <span class="roomId" id="roomIdDisplay"></span>
        <button id="copyRoomBtn">üìã Copiar</button>
      </div>

      <h2>üë• Jugadores (<span id="playerCount">0</span>)</h2>
      <div class="playersList" id="playersList"></div>

      <h2>üéÆ Acciones</h2>
      <div class="btnRow">
        <button class="action" id="rollBtn" disabled>üé≤ Tirar</button>
        <button class="action" id="endBtn" disabled>üìç Finalizar</button>
        <button class="action" id="buyBtn" disabled>üí∞ Comprar</button>
        <button class="action" id="buildBtn" disabled>üè† Construir</button>
        <button class="action" id="mortBtn" disabled>üè¶ Hipotecar</button>
      </div>

      <h2>üìä Estado</h2>
      <div style="background:var(--tile-bg);padding:10px;border-radius:4px;border:2px solid var(--tile-border);transition:all 0.3s">
        <div><strong>Turno:</strong> <span id="turnInfo">-</span></div>
        <div style="margin-top:6px"><strong>Dados:</strong> <span id="diceSmall">-</span></div>
        <div style="margin-top:6px"><strong>Dinero:</strong> <span id="moneyInfo" style="color:var(--success);font-weight:900">$0</span></div>
      </div>

      <h2>üìú Registro</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <div class="boardWrap">
    <div class="board" id="board">
      <div class="boardInner" id="boardInner"></div>
    </div>
  </div>
</div>

<div id="modalRoot"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ===== TOGGLE TEMA OSCURO =====
const themeToggle = document.getElementById('themeToggle');
const body = document.body;

const savedTheme = localStorage.getItem('monopolyTheme') || 'light';
if (savedTheme === 'dark') {
  body.classList.add('dark-mode');
  themeToggle.textContent = '‚òÄÔ∏è Claro';
}

themeToggle.onclick = () => {
  body.classList.toggle('dark-mode');
  const isDark = body.classList.contains('dark-mode');
  themeToggle.textContent = isDark ? '‚òÄÔ∏è Claro' : 'üåô Oscuro';
  localStorage.setItem('monopolyTheme', isDark ? 'dark' : 'light');
};

// ===== SOCKET IO Y L√ìGICA DEL JUEGO =====
const socket = io();
let state = null;
let myId = null;
let currentRoomId = null;

const createBtn = document.getElementById('createBtn');
const joinBtn = document.getElementById('joinBtn');
const startBtn = document.getElementById('startBtn');
const rollBtn = document.getElementById('rollBtn');
const endBtn = document.getElementById('endBtn');
const buyBtn = document.getElementById('buyBtn');
const buildBtn = document.getElementById('buildBtn');
const mortBtn = document.getElementById('mortBtn');
const nameInput = document.getElementById('name');
const roomInput = document.getElementById('room');
const playersList = document.getElementById('playersList');
const turnInfo = document.getElementById('turnInfo');
const moneyInfo = document.getElementById('moneyInfo');
const boardInner = document.getElementById('boardInner');
const logEl = document.getElementById('log');
const diceSmall = document.getElementById('diceSmall');
const modalRoot = document.getElementById('modalRoot');
const alertsDiv = document.getElementById('alerts');
const roomInfo = document.getElementById('roomInfo');
const roomIdDisplay = document.getElementById('roomIdDisplay');
const copyRoomBtn = document.getElementById('copyRoomBtn');
const playerCount = document.getElementById('playerCount');

const savedName = localStorage.getItem('playerName');
if (savedName) nameInput.value = savedName;

nameInput.addEventListener('input', (e) => {
  localStorage.setItem('playerName', e.target.value);
});

roomInput.addEventListener('input', (e) => {
  e.target.value = e.target.value.toUpperCase();
});

function showAlert(message, type = 'info') {
  const alert = document.createElement('div');
  alert.className = `alert ${type}`;
  alert.textContent = message;
  alertsDiv.appendChild(alert);
  setTimeout(() => alert.remove(), 5000);
}

function log(txt) {
  const d = document.createElement('div');
  d.textContent = `[${new Date().toLocaleTimeString()}] ${txt}`;
  logEl.prepend(d);
  while (logEl.children.length > 50) {
    logEl.removeChild(logEl.lastChild);
  }
}

function sanitizeInput(input) {
  return input.replace(/[<>]/g, '').trim().substring(0, 20);
}

createBtn.onclick = () => {
  const name = sanitizeInput(nameInput.value) || 'Jugador';
  if (name.length < 2) {
    showAlert('Nombre requerido (m√≠n. 2 caracteres)', 'error');
    nameInput.focus();
    return;
  }
  localStorage.setItem('playerName', name);
  socket.emit('createRoom', { name });
  log('Creando nueva sala...');
};

joinBtn.onclick = () => {
  const name = sanitizeInput(nameInput.value) || 'Jugador';
  const roomId = sanitizeInput(roomInput.value);
  if (!name || name.length < 2) {
    showAlert('Nombre requerido (m√≠n. 2 caracteres)', 'error');
    nameInput.focus();
    return;
  }
  if (!roomId) {
    showAlert('ID de sala requerido', 'error');
    roomInput.focus();
    return;
  }
  localStorage.setItem('playerName', name);
  socket.emit('joinRoom', { name, roomId });
  log(`Uni√©ndose a sala ${roomId}...`);
};

socket.on('connect', () => {
  myId = socket.id;
  showAlert('‚úÖ Conectado al servidor', 'success');
});

socket.on('disconnect', () => {
  showAlert('‚ùå Desconectado del servidor', 'error');
});

socket.on('message', m => {
  const msg = m.text || JSON.stringify(m);
  log(msg);
  if (m.type === 'error') showAlert(msg, 'error');
  else if (m.type === 'success') showAlert(msg, 'success');
  else if (m.type === 'info') showAlert(msg, 'info');
});

socket.on('roomCreated', ({ roomId }) => {
  currentRoomId = roomId;
  roomIdDisplay.textContent = roomId;
  roomInput.value = roomId;
  roomInfo.style.display = 'block';
  startBtn.disabled = false;
  log(`‚úÖ Sala creada: ${roomId}`);
  showAlert(`Sala creada: ${roomId}`, 'success');
});

socket.on('roomJoined', ({ roomId }) => {
  currentRoomId = roomId;
  roomIdDisplay.textContent = roomId;
  roomInfo.style.display = 'block';
  log(`‚úÖ Unido a sala: ${roomId}`);
  showAlert(`Unido a sala ${roomId}`, 'success');
});

socket.on('roomState', s => {
  state = s;
  renderState();
});

socket.on('diceRolled', ({ die1, die2, playerId, playerName }) => {
  showDiceResult(die1, die2, playerId, playerName);
});

startBtn.onclick = () => {
  if (!currentRoomId) return;
  socket.emit('startGame', currentRoomId);
};

rollBtn.onclick = () => {
  if (!currentRoomId) return;
  showDiceLoadingModal();
  socket.emit('rollDice', currentRoomId);
};

endBtn.onclick = () => {
  if (!currentRoomId) return;
  socket.emit('endTurn', currentRoomId);
};

buyBtn.onclick = () => {
  if (!state || !currentRoomId) return;
  const me = state.players.find(p => p.id === myId);
  if (!me) return;
  const tile = state.board[me.position];
  if (tile && tile.price && tile.owner === null) {
    socket.emit('buyProperty', { roomId: currentRoomId, propIndex: tile.idx });
  }
};

buildBtn.onclick = () => {
  if (!state || !currentRoomId) return;
  const me = state.players.find(p => p.id === myId);
  if (!me) return;
  const candidate = me.properties.find(pi => (me.houses[pi] || 0) < 5);
  if (candidate !== undefined) {
    socket.emit('build', { roomId: currentRoomId, propIndex: candidate });
  } else {
    showAlert('No puedes construir m√°s casas', 'info');
  }
};

mortBtn.onclick = () => {
  if (!state || !currentRoomId) return;
  const me = state.players.find(p => p.id === myId);
  if (!me) return;
  const candidate = me.properties.find(pi => !state.board[pi].mortgaged);
  if (candidate !== undefined) {
    socket.emit('mortgageProperty', { roomId: currentRoomId, propIndex: candidate });
  } else {
    showAlert('No tienes propiedades para hipotecar', 'info');
  }
};

copyRoomBtn.onclick = () => {
  navigator.clipboard.writeText(currentRoomId).then(() => {
    showAlert('‚úÖ ID copiado', 'success');
    copyRoomBtn.textContent = '‚úì Copiado';
    setTimeout(() => { copyRoomBtn.textContent = 'üìã Copiar'; }, 2000);
  });
};

function showDiceLoadingModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-simple';
  modal.id = 'diceModal';
  const inner = document.createElement('div');
  inner.style.textAlign = 'center';
  const diceBox = document.createElement('div');
  diceBox.className = 'diceBox';
  const a = document.createElement('div');
  a.className = 'dieSimple';
  a.id = 'die1';
  const b = document.createElement('div');
  b.className = 'dieSimple';
  b.id = 'die2';
  a.textContent = '?';
  b.textContent = '?';
  diceBox.appendChild(a);
  diceBox.appendChild(b);
  const caption = document.createElement('div');
  caption.className = 'caption';
  caption.id = 'diceCaption';
  caption.textContent = 'Tirando...';
  inner.appendChild(diceBox);
  inner.appendChild(caption);
  modal.appendChild(inner);
  modalRoot.appendChild(modal);
}

function showDiceResult(v1, v2, playerId, playerName) {
  const modal = document.getElementById('diceModal');
  if (!modal) {
    showDiceLoadingModal();
    setTimeout(() => showDiceResult(v1, v2, playerId, playerName), 100);
    return;
  }
  const die1 = document.getElementById('die1');
  const die2 = document.getElementById('die2');
  const caption = document.getElementById('diceCaption');
  let frames = 0;
  const ticks = 8;
  const timer = setInterval(() => {
    frames++;
    die1.textContent = Math.floor(Math.random() * 6) + 1;
    die2.textContent = Math.floor(Math.random() * 6) + 1;
    die1.classList.add('diePulse');
    die2.classList.add('diePulse');
    setTimeout(() => {
      die1.classList.remove('diePulse');
      die2.classList.remove('diePulse');
    }, 150);
    if (frames >= ticks) {
      clearInterval(timer);
      die1.textContent = v1;
      die2.textContent = v2;
      const total = v1 + v2;
      const isDouble = v1 === v2;
      caption.textContent = `${playerName}: ${v1} + ${v2} = ${total}`;
      if (isDouble) caption.textContent += ' ¬°DOBLES!';
      diceSmall.textContent = `${v1} + ${v2} = ${total}`;
      setTimeout(() => {
        if (modalRoot.contains(modal)) modalRoot.removeChild(modal);
      }, 1800);
    }
  }, 100);
}

function renderState() {
  if (!state) return;
  playersList.innerHTML = '';
  playerCount.textContent = state.players.length;
  state.players.forEach((p, i) => {
    const card = document.createElement('div');
    card.className = 'playerCard';
    if (p.id === myId) card.classList.add('active');
    if (p.disconnected) card.classList.add('disconnected');
    const token = document.createElement('div');
    token.className = 'token';
    token.style.background = colorFor(i);
    token.textContent = i + 1;
    const info = document.createElement('div');
    info.style.flex = '1';
    let statusIcon = '';
    if (p.inJail) statusIcon = 'üîí';
    if (p.bankrupt) statusIcon = 'üíÄ';
    if (p.disconnected) statusIcon = 'üì°';
    info.innerHTML = `<strong>${p.name} ${statusIcon}</strong><div style="font-size:12px;color:var(--muted);margin-top:2px">üí∞ $${p.money} ‚Ä¢ üìç Pos ${p.position} ${p.properties.length > 0 ? ` ‚Ä¢ üè† ${p.properties.length}` : ''}</div>`;
    card.appendChild(token);
    card.appendChild(info);
    playersList.appendChild(card);
  });
  const current = state.players[state.turnIndex];
  turnInfo.textContent = current ? current.name : '-';
  const me = state.players.find(p => p.id === myId);
  moneyInfo.textContent = me ? ('$' + me.money) : '$0';
  const myTurn = me && current && me.id === current.id && state.started && !me.bankrupt;
  rollBtn.disabled = !myTurn || me?.rolledThisTurn;
  endBtn.disabled = !myTurn;
  const onMyProperty = me && state.board[me.position];
  buyBtn.disabled = !(myTurn && onMyProperty && onMyProperty.price && onMyProperty.owner === null && me.money >= onMyProperty.price);
  buildBtn.disabled = !(me && me.properties.length > 0);
  mortBtn.disabled = !(me && me.properties.length > 0);
  startBtn.disabled = state.started || state.players.length < 2;
  renderBoard();
  logEl.innerHTML = '';
  (state.log || []).slice(0, 50).forEach(l => {
    const div = document.createElement('div');
    div.textContent = l;
    logEl.appendChild(div);
  });
}

function renderBoard() {
  boardInner.innerHTML = '';
  const tileSize = 78;
  const offset = 10;
  state.board.forEach(t => {
    const c = getTileCoords(t.idx);
    const el = document.createElement('div');
    el.className = 'tile';
    el.style.left = (c[0] * tileSize + offset) + 'px';
    el.style.top = (c[1] * tileSize + offset) + 'px';
    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = t.name;
    el.appendChild(title);
    if (t.color) {
      const bar = document.createElement('div');
      bar.className = 'colorBar';
      bar.style.background = colorForName(t.color);
      el.appendChild(bar);
    }
    if (t.price) {
      const price = document.createElement('div');
      price.style.fontSize = '10px';
      price.style.color = 'var(--text)';
      price.style.fontWeight = '700';
      price.textContent = '$' + t.price;
      el.appendChild(price);
    }
    const markers = document.createElement('div');
    markers.className = 'playersMarkers';
    state.players.forEach((pl, i) => {
      if (pl.position === t.idx && !pl.bankrupt) {
        const mk = document.createElement('div');
        mk.className = 'tokenSmall';
        mk.style.background = colorFor(i);
        markers.appendChild(mk);
      }
    });
    el.appendChild(markers);
    if (t.owner) {
      const ownerIdx = state.players.findIndex(p => p.id === t.owner);
      if (ownerIdx >= 0) {
        const badge = document.createElement('div');
        badge.className = 'ownerBadge';
        badge.style.background = colorFor(ownerIdx);
        el.appendChild(badge);
      }
    }
    if (t.mortgaged) {
      const mortLabel = document.createElement('div');
      mortLabel.style.cssText = 'position:absolute;top:2px;right:2px;font-size:9px;background:var(--error);color:#fff;padding:1px 2px;border-radius:2px;font-weight:700';
      mortLabel.textContent = 'HIP';
      el.appendChild(mortLabel);
    }
    boardInner.appendChild(el);
  });
}

function getTileCoords(pos) {
  const n = 11;
  const ring = [];
  for (let x = n - 1; x >= 0; x--) ring.push([x, n - 1]);
  for (let y = n - 2; y >= 1; y--) ring.push([0, y]);
  for (let x = 0; x <= n - 1; x++) ring.push([x, 0]);
  for (let y = 1; y <= n - 2; y++) ring.push([n - 1, y]);
  return ring[pos] || [0, 0];
}

function colorFor(i) {
  const cols = ['#ed1b24', '#0072bb', '#1fb25a', '#f7941d', '#8b4513', '#d93a96', '#fef200', '#aaddf6'];
  return cols[i % cols.length];
}

function colorForName(n) {
  const map = {
    brown: '#8b4513',
    lightblue: '#aaddf6',
    pink: '#d93a96',
    orange: '#f7941d',
    red: '#ed1b24',
    yellow: '#fef200',
    green: '#1fb25a',
    darkblue: '#0072bb',
    rail: '#2d2d2d',
    utility: '#87ceeb'
  };
  return map[n] || '#ccc';
}

console.log('üé≤ Monopoly Poblenou - Cargado');
</script>
</body>
</html>